name: Gemini PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Install dependencies
        run: |
          npm cache clean --force
          npm install
      
      - name: ğŸ¤– AI Code Reviewer - Starting Analysis
        run: |
          echo "ğŸš€ Starting Gemini AI Code Review for PR #${{ github.event.number }}"
          echo "ğŸ“Š This will analyze your code for:"
          echo "  ğŸ›¡ï¸ Security vulnerabilities"
          echo "  âš¡ Performance issues" 
          echo "  ğŸ“ Code quality problems"
          echo "  ğŸ¯ Custom team rules (41+ rules)"
          echo ""
          echo "â±ï¸ Expected completion time: 2-3 minutes"
          echo "ğŸ“„ Reports will be generated in multiple formats"

      - name: Run Gemini PR Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
          NODE_ENV: production
        run: npm start
        timeout-minutes: 10

      - name: Display Pipeline Report Summary
        if: always()
        run: node scripts/pipeline-reporter.js summary

      - name: Generate GitHub Actions Step Summary
        if: always()
        run: node scripts/pipeline-reporter.js step-summary

      - name: ğŸš¨ Check Merge Eligibility (Quality Gate)
        if: always()
        env:
          GITHUB_PR_NUMBER: ${{ github.event.number }}
        run: node scripts/check-merge-status.js

      - name: Upload Reports as Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-review-reports-pr-${{ github.event.number }}
          path: |
            reports/
            test-report.*
          retention-days: 30

      - name: Display Report Links
        if: always()
        run: |
          echo "ğŸ“„ === REPORT LOCATIONS ==="
          echo "1. ğŸ’¬ PR Comment: Check the PR for detailed review comment"
          echo "2. ğŸ“ Artifacts: Download from Actions > Artifacts section"
          echo "3. ğŸ” Logs: Scroll up to see detailed analysis logs"
          echo "4. ğŸ“Š Summary: See above for key metrics"

      - name: ğŸ‰ AI Review Complete
        if: success()
        run: |
          echo "âœ… Gemini AI Code Review completed successfully!"
          echo "ğŸ“ Enhanced review comment has been posted to the PR"
          echo "ğŸ“Š Check the PR conversation for detailed analysis and recommendations"

      - name: âŒ AI Review Failed
        if: failure()
        run: |
          echo "âŒ Gemini AI Code Review encountered an error"
          echo "ğŸ” Check the logs above for details"
          echo "ğŸ’¡ Common issues: API quota exceeded, network issues, or configuration problems"